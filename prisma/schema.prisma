// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // Hashed Password
  createdAt DateTime @default(now())

  // Relations
  gamesAsPlayer1 Game[] @relation("Player1")
  gamesAsPlayer2 Game[] @relation("Player2")
  moves          Move[]
}

model Game {
  id        String   @id @default(uuid())
  
  // Players
  player1Id String
  player1   User     @relation("Player1", fields: [player1Id], references: [id])
  player2Id String?
  player2   User?    @relation("Player2", fields: [player2Id], references: [id])
  
  // Game State
  status    String   @default("WAITING") // WAITING, IN_PROGRESS, FINISHED
  board     String   @default("---------") // 9 chars: -, X, O
  turn      String   // User ID of current turn
  winnerId  String?  // Null = Draw or Not finished
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  moves     Move[]
}

model Move {
  id        String   @id @default(uuid())
  gameId    String
  game      Game     @relation(fields: [gameId], references: [id])
  
  playerId  String
  player    User     @relation(fields: [playerId], references: [id])
  
  position  Int      // 0-8
  createdAt DateTime @default(now())

  // --- üî• RACE CONDITION PROTECTION ---
  // ‡∏Å‡∏é: ‡πÉ‡∏ô 1 ‡πÄ‡∏Å‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î (Database ‡∏à‡∏∞ Reject ‡πÄ‡∏≠‡∏á)
  @@unique([gameId, position]) 
}